{% extends 'base.html' %}
{% block title %}HOUSE MOA{% endblock %}

{% block content %}
<!-- ë¸Œë ˆë“œí¬ëŸ¼ -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">í™ˆ</a></li>
    <li class="breadcrumb-item"><a href="/plus">MOA PLUS</a></li>
    <li class="breadcrumb-item"><a href="/plus/region">ë‹¹ì‹ ì˜ ë¯¸ë˜ë¥¼ ëª¨ìœ¼ëŠ” ì‹œê°„</a></li>
    <li class="breadcrumb-item active" aria-current="page">HOUSE MOA</li>
  </ol>
</nav>
<style>
  :root {
    --moa-green: #00C4A8;
    --moa-light: #8AE2BB;
    --moa-dark: #020715;
    --primary-color: #00B37D;
    --light-bg: #E8F9F5;
    --accent-color: #4ECDC4;
    --gray-light: #F8F9FA;
    --gray-medium: #E9ECEF;
    --gray-dark: #6C757D;
    --loan-accent: #FF6B35;
    --loan-light: #FFE5DC;
  }

  /* íƒ€ì´í‹€ - ê¸°ì¡´ ìœ ì§€ */
  .moa-header {
    transform: translateY(-1cm);
    background: white;
    padding: 80px 20px 20px;
    text-align: center;
    font-family: 'NoonnuBasicGothic', sans-serif;
  }
  .moa-header .moa-bar {
    width: 53px;
    height: 10px;
    background-color:#8AE4D7;
    margin: 0 auto 30px;
  }
  .moa-header h1 {
    font-size: 4rem;
    font-weight: 700;
    color: var(--moa-green);
    letter-spacing: 1.5px;
  }
  .moa-header h1 .black-text {
    color: #333333;
  }
  .moa-header h1 .green-text {
    color: var(--moa-green);
  }
  .moa-header p {
    font-size: 1.5rem;
    color: #717171;
    margin-top: 10px;
    letter-spacing: 1.1px;
  }

  /* ë©”ì¸ ë°”ë”” ìŠ¤íƒ€ì¼ */
  body {
    background-color: #ffffff;
    padding: 40px 20px;
    font-family: 'NoonnuBasicGothic', sans-serif;
  }

  /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
  .row {
    display: flex;
    flex-wrap: nowrap;
    gap: 40px;
    justify-content: center;
    max-width: 1600px;
    margin: 0 auto;
    align-items: flex-start;
  }

  /* ì§€ë„ ì„¹ì…˜ - ì•ˆì •ì ì¸ ë””ìì¸ */
  .col-lg-8 {
    flex: 0 0 55%;
    max-width: 55%;
  }

  #mapdiv {
    width: 100%;
    background: #E8F4FD;
    padding: 80px;
    border-radius: 20px;
    border: none;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    position: relative;
  }

  svg {
    max-width: 800px;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  svg path {
    stroke: #DEE2E6 !important;
    stroke-width: 1;
    fill: #F8F8F8;
    transition: fill 0.3s ease;
    cursor: pointer;
    pointer-events: all;
  }

  svg path:hover {
    fill: #DEE2E6 !important;
  }

  .region-label {
    font-family: 'NoonnuBasicGothic', sans-serif;
    font-size: 13px;
    font-weight: bold;
    pointer-events: none;
    fill: #333;
  }

  /* ìš°ì¸¡ ì •ë³´ íŒ¨ë„ - í˜„ëŒ€ì ì¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .col-lg-4 {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 16px;
    border: 1px solid #E5E7EB;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    flex: 0 0 40%;
    max-width: 40%;
  }

  /* ì„ íƒëœ ì§€ì—­ ì •ë³´ */
  #selected-region {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 12px;
  }

  #avg-price {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #E5E7EB;
  }

  /* ìƒí™˜ ê°œì›”ìˆ˜ ì„ íƒ */
  .repayment-selector {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #E5E7EB;
  }

  .repayment-selector label {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
  }

  .repayment-selector select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 1rem;
    color: #333;
    background-color: #ffffff;
    transition: border-color 0.3s ease;
    cursor: pointer;
  }

  .repayment-selector select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 179, 125, 0.1);
  }

  .repayment-selector select:hover {
    border-color: var(--accent-color);
  }

  /* ëŒ€ì¶œìƒí’ˆ ì œëª© */
  .loan-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
  }

  /* ëŒ€ì¶œìƒí’ˆ ë¦¬ìŠ¤íŠ¸ */
  #loan-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #loan-list .list-group-item {
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 20px;
    background-color: #ffffff;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  #loan-list .list-group-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 6px 20px rgba(0, 179, 125, 0.15);
    transform: translateY(-2px);
  }

  #loan-list .list-group-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--primary-color);
  }

  /* ì •ë¶€ì§€ì› ëŒ€ì¶œ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
  #loan-list .government-loan {
    background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
    border-color: #0EA5E9;
    border-width: 2px;
  }

  #loan-list .government-loan::before {
    background: linear-gradient(180deg, #0EA5E9, #0284C7);
  }

  #loan-list .government-loan:hover {
    border-color: #0284C7;
    box-shadow: 0 6px 20px rgba(14, 165, 233, 0.2);
  }

  /* ìƒí’ˆëª… ìŠ¤íƒ€ì¼ */
  .product-name {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.4;
  }

  .product-rate {
    color: var(--primary-color);
    font-weight: 700;
  }

  .government-loan .product-rate {
    color: #0EA5E9;
  }

  .product-company {
    color: #333333;
    font-weight: 500;
  }

  .government-badge {
    background: none;
    color: #0EA5E9;
    font-size: 1.2rem;
    font-weight: 400;
    padding: 0;
    border-radius: 0;
    margin-left: 8px;
  }

  .government-badge::before {
    content: "ğŸ›ï¸";
    font-size: 1.2rem;
  }

  /* ìƒí’ˆ ìƒì„¸ ì •ë³´ */
  .product-details {
    font-size: 0.9rem;
    color: var(--gray-dark);
    line-height: 1.5;
  }

  .highlight {
    color: #333;
    font-weight: 600;
  }

  .loan-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    padding: 8px 0;
  }

  .loan-amount {
    color: #333333;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .monthly-payment {
    color: #fff;
    background: var(--primary-color);
    font-weight: 500;
    font-size: 1.1rem;
    padding: 6px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 179, 125, 0.2);
  }

  .government-loan .monthly-payment {
    background: #0EA5E9;
    box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
  }

  /* ì•ˆë‚´ ì •ë³´ ì„¹ì…˜ */
  .info-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #E5E7EB;
  }

  .info-notice {
    background: #F8F9FA;
    border: 1px solid #E9ECEF;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
  }

  .info-notice h5 {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
  }

  .info-notice ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .info-notice ul li {
    font-size: 0.85rem;
    color: #6C757D;
    line-height: 1.5;
    margin-bottom: 6px;
    position: relative;
    padding-left: 12px;
  }

  .info-notice ul li::before {
    content: "â€¢";
    color: var(--primary-color);
    font-weight: bold;
    position: absolute;
    left: 0;
  }

  .info-date {
    text-align: right;
  }

  .info-date p {
    font-size: 0.8rem;
    color: #6C757D;
    margin: 0;
    font-style: italic;
  }

  /* ë¸Œë ˆë“œí¬ëŸ¼ ìŠ¤íƒ€ì¼ */
  .breadcrumb {
    background: none;
    padding: 20px 0;
    margin-bottom: 20px;
    font-size: 0.9rem;
    text-align: right;
    justify-content: flex-end;
  }

  .breadcrumb-item {
    color: #6C757D;
  }

  .breadcrumb-item + .breadcrumb-item::before {
    content: ">";
    color: #6C757D;
    margin: 0 8px;
  }

  .breadcrumb-item a {
    color: #6C757D;
    text-decoration: none;
  }

  .breadcrumb-item a:hover {
    color: var(--primary-color);
    text-decoration: underline;
  }

  .breadcrumb-item.active {
    color: #333;
    font-weight: 600;
  }

  /* íˆ´íŒ */
  .region-tooltip {
    position: absolute;
    background: #333;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 1000;
    pointer-events: none;
  }

  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 1200px) {
    .row {
      flex-wrap: wrap;
    }
    
    .col-lg-8, .col-lg-4 {
      flex: none;
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .row {
      flex-direction: column;
      gap: 20px;
    }

    .col-lg-8, .col-lg-4 {
      width: 100%;
      max-width: 100%;
      min-width: auto;
    }

    #mapdiv {
      padding: 30px 20px;
    }

    #selected-region {
      font-size: 1.2rem;
    }

    #avg-price {
      font-size: 1rem;
    }

    .moa-header h1 {
      font-size: 3rem;
    }

    .moa-header p {
      font-size: 1.2rem;
    }

    .loan-info {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .monthly-payment {
      align-self: flex-end;
    }
  }
</style>

<!-- íƒ€ì´í‹€ - ê¸°ì¡´ ìœ ì§€ -->
<div class="moa-header">
  <div class="moa-bar"></div>
  <h1><span class="black-text">HOUSE</span> <span class="green-text">MOA</span></h1>
  <p>ì§‘ ì‚´ëˆ, ì—¬ê¸°ì„œ ëª¨ì•„ë´ !</p>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="row">
  <div class="col-lg-8">
    <div id="mapdiv">
      {% include 'ì „êµ­_ì‹œë„_ì „ì„¸ì§€ë„_ì¸í„°ë™í‹°ë¸Œ.html' %}
    </div>
  </div>
  <div class="col-lg-4">
    <h3 id="selected-region">ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
    <p id="avg-price">í‰ê·  ì£¼íƒ ì „ì„¸ê°€: -</p>
    
    <div class="repayment-selector">
      <label for="repayment-months">ìƒí™˜ ê¸°ê°„</label>
      <select id="repayment-months">
        <option value="24">2ë…„ (24ê°œì›”)</option>
        <option value="36">3ë…„ (36ê°œì›”)</option>
        <option value="48">4ë…„ (48ê°œì›”)</option>
        <option value="60">5ë…„ (60ê°œì›”)</option>
        <option value="120">10ë…„ (120ê°œì›”)</option>
      </select>
    </div>
    
    <h4 class="loan-title">ì¶”ì²œ ì£¼íƒëŒ€ì¶œìƒí’ˆ</h4>
    <ul id="loan-list" class="list-group"></ul>
    
    <!-- ì•ˆë‚´ ì •ë³´ -->
    <div class="info-section">
      <div class="info-notice">
        <h5>ìœ ì˜ì‚¬í•­</h5>
        <ul>
          <li>ìƒê¸° ê¸ˆë¦¬ëŠ” 2025ë…„ 6ì›” 12ì¼ ê¸°ì¤€ì´ë©°, ì‹œì¥ ìƒí™©ì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì‹¤ì œ ì ìš© ê¸ˆë¦¬ëŠ” ê³ ê°ì˜ ì‹ ìš©ë“±ê¸‰, ì†Œë“ìˆ˜ì¤€, ë‹´ë³´ê°€ì¹˜ ë“±ì— ë”°ë¼ ì°¨ë“± ì ìš©ë©ë‹ˆë‹¤.</li>
          <li>ì›” ìƒí™˜ê¸ˆì•¡ì€ ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜ ê¸°ì¤€ ì˜ˆìƒ ê¸ˆì•¡ìœ¼ë¡œ, ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ëŒ€ì¶œ ìŠ¹ì¸ ë° í•œë„ëŠ” ë‹¹í–‰ ë‚´ë¶€ ì‹¬ì‚¬ê¸°ì¤€ì— ë”°ë¼ ê²°ì •ë˜ë©°, ì‹ ì²­ ì‹œ êµ¬ë¹„ì„œë¥˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
          <li>ì¤‘ë„ìƒí™˜ ì‹œ ì¤‘ë„ìƒí™˜ìˆ˜ìˆ˜ë£Œê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆ, ì•½ì •ì„œë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
          <li>ëŒ€ì¶œ ê´€ë ¨ ìƒì„¸ ì¡°ê±´ì€ ê° ê¸ˆìœµê¸°ê´€ ì˜ì—…ì ì— ë¬¸ì˜í•˜ì‹œê±°ë‚˜ í™ˆí˜ì´ì§€ë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
        </ul>
      </div>
      <div class="info-date">
        <p><strong>ì •ë³´ê¸°ì¤€ì¼:</strong> 2025ë…„ 6ì›” 12ì¼</p>
      </div>
    </div>
  </div>
</div>

<div class="region-tooltip" id="tooltip"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const paths = document.querySelectorAll('svg path, polyline');
  const tooltip = document.getElementById('tooltip');
  const repaymentSelect = document.getElementById('repayment-months');
  let selectedPath = null;
  let currentRegionData = null;

  // ìƒí™˜ ê¸°ê°„ ë³€ê²½ ì‹œ ì›”ìƒí™˜ê¸ˆ ì¬ê³„ì‚°
  repaymentSelect.addEventListener('change', function() {
    if (currentRegionData) {
      updateLoanProducts(currentRegionData, parseInt(this.value));
    }
  });

  // ì›”ìƒí™˜ê¸ˆ ê³„ì‚° í•¨ìˆ˜
  function calculateMonthlyPayment(loanAmount, annualRate, months) {
    if (!loanAmount || loanAmount === 'ì œí•œì—†ìŒ' || annualRate <= 0) {
      return 'ê³„ì‚°ë¶ˆê°€';
    }
    
    const monthlyRate = annualRate / 100 / 12;
    const totalAmount = loanAmount * 10000; // ë§Œì›ì„ ì›ìœ¼ë¡œ ë³€í™˜
    
    if (monthlyRate === 0) {
      return Math.round(totalAmount / months / 10000); // ë¬´ì´ìì¸ ê²½ìš°
    }
    
    // ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜ ê³µì‹
    const monthlyPayment = totalAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
    return Math.round(monthlyPayment / 10000); // ë§Œì› ë‹¨ìœ„ë¡œ ë°˜í™˜
  }

  // ëŒ€ì¶œ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateLoanProducts(data, repaymentMonths) {
    const list = document.getElementById('loan-list');
    list.innerHTML = '';

    const seen = new Set();
    data.products.slice(0, 6).forEach(p => {
      const key = `${p.ìƒí’ˆëª…}-${p.ê¸ˆìœµíšŒì‚¬ëª…}`;
      if (seen.has(key)) return;
      seen.add(key);

      const li = document.createElement('li');
      li.className = 'list-group-item';
      
      if (p.ìƒí’ˆíƒ€ì… === 'ì •ë¶€ì§€ì›') {
        li.classList.add('government-loan');
      }

      // ëŒ€ì¶œí•œë„ í¬ë§·íŒ…
      let loanLimitText;
      if (p['ëŒ€ì¶œí•œë„(ë§Œì›)'] === 'ì œí•œì—†ìŒ') {
        loanLimitText = 'ì œí•œì—†ìŒ';
      } else {
        const limit = p['ëŒ€ì¶œí•œë„(ë§Œì›)'];
        if (limit >= 10000) {
          const eok = Math.floor(limit / 10000);
          const man = limit % 10000;
          loanLimitText = man === 0 ? `${eok}ì–µì›` : `${eok}ì–µ ${man.toLocaleString()}ë§Œì›`;
        } else {
          loanLimitText = `${limit.toLocaleString()}ë§Œì›`;
        }
      }

      // ìµœì†Œ ê¸ˆë¦¬ ì¶”ì¶œ (ì˜ˆ: "2.88~9.70%" â†’ 2.88)
      const minRate = parseFloat(p.ê¸ˆë¦¬.replace('%', '').split('~')[0]);
      
      // ìƒˆë¡œìš´ ì›”ìƒí™˜ê¸ˆ ê³„ì‚°
      const monthlyPayment = calculateMonthlyPayment(p['ëŒ€ì¶œí•œë„(ë§Œì›)'], minRate, repaymentMonths);
      const monthlyPaymentText = monthlyPayment !== 'ê³„ì‚°ë¶ˆê°€' ? `ì›” ìƒí™˜ê¸ˆì•¡: ${monthlyPayment.toLocaleString()}ë§Œì›` : '';

      li.innerHTML = `
        <div class="product-name">
          <strong>${p.ìƒí’ˆëª…}</strong>
          ${p.ìƒí’ˆíƒ€ì… === 'ì •ë¶€ì§€ì›' ? '<span class="government-badge"></span>' : ''}
          <br>
          <span class="product-rate">${p.ê¸ˆë¦¬}</span> - 
          <span class="product-company">${p.ê¸ˆìœµíšŒì‚¬ëª…}</span>
        </div>
        <div class="product-details">
          <div class="loan-info">
            <span class="loan-amount">í•œë„: ${loanLimitText}</span>
            ${monthlyPaymentText ? `<span class="monthly-payment">${monthlyPaymentText}</span>` : ''}
          </div>
        </div>
      `;
      list.appendChild(li);
    });
  }

  paths.forEach(path => {
    const title = path.getAttribute('id');
    if (!title) return;

    path.style.cursor = 'pointer';

    path.addEventListener('mousemove', function (e) {
      tooltip.innerText = title;
      tooltip.style.left = (e.pageX + 10) + 'px';
      tooltip.style.top = (e.pageY + 10) + 'px';
      tooltip.style.display = 'block';
    });

    path.addEventListener('mouseleave', function () {
      tooltip.style.display = 'none';
    });

    path.addEventListener('click', function () {
      if (selectedPath) {
        selectedPath.style.fill = '#F8F8F8';
      }

      path.style.fill = '#D1D5DB';
      selectedPath = path;

      const region = title.replace(" ì›", "").trim();
      document.getElementById('selected-region').innerText = 'ì§€ì—­: ' + region;

      fetch(`/plus/region-data?region=${region}`)
        .then(res => res.json())
        .then(data => {
          currentRegionData = data; // ë°ì´í„° ì €ì¥
          
          // ê°€ê²© í‘œì‹œ (ê°€ë…ì„± ë†’ê²Œ)
          if (data.price && data.price !== 'ì •ë³´ì—†ìŒ') {
            const price = typeof data.price === 'number' ? data.price : parseFloat(data.price);
            
            let formattedPrice;
            if (price >= 10000) {
              // 1ì–µ ì´ìƒ: 3ì–µ 713ë§Œì›
              const eok = Math.floor(price / 10000);
              const man = price % 10000;
              if (man === 0) {
                formattedPrice = `${eok}ì–µì›`;
              } else {
                formattedPrice = `${eok}ì–µ ${man.toLocaleString()}ë§Œì›`;
              }
            } else {
              // 1ì–µ ë¯¸ë§Œ: 3,071ë§Œì›
              formattedPrice = `${price.toLocaleString()}ë§Œì›`;
            }
            document.getElementById('avg-price').innerText = 'í‰ê·  ì „ì„¸ê°€: ' + formattedPrice;
          } else {
            document.getElementById('avg-price').innerText = 'í‰ê·  ì „ì„¸ê°€: ì •ë³´ì—†ìŒ';
          }

          // í˜„ì¬ ì„ íƒëœ ìƒí™˜ ê¸°ê°„ìœ¼ë¡œ ìƒí’ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
          const selectedMonths = parseInt(repaymentSelect.value);
          updateLoanProducts(data, selectedMonths);
        })
        .catch(error => {
          console.error('Error fetching region data:', error);
        });
    });
  });
});
</script>
{% endblock %}